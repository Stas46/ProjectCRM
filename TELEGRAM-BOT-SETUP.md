# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ë–æ—Ç–∞ –¥–ª—è CRM

## 1. –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather

1. –û—Ç–∫—Ä–æ–π Telegram –∏ –Ω–∞–π–¥–∏ **@BotFather**
2. –û—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –í–≤–µ–¥–∏ –∏–º—è –±–æ—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: `Stella CRM Assistant`
4. –í–≤–µ–¥–∏ username –±–æ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `bot`), –Ω–∞–ø—Ä–∏–º–µ—Ä: `stella_crm_bot`
5. **–°–∫–æ–ø–∏—Ä—É–π —Ç–æ–∫–µ–Ω** –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞—Å—Ç BotFather (—Ñ–æ—Ä–º–∞—Ç: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)

## 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ .env.local

–î–æ–±–∞–≤—å –≤ —Ñ–∞–π–ª `.env.local`:

```env
TELEGRAM_BOT_TOKEN=—Ç–≤–æ–π_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather
```

## 3. –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–Ω–∏–º–∞—Ç—å:

### –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `/start` - –ü—Ä–∏–≤—è–∑–∫–∞ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞ –∫ CRM
- `/help` - –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
- `/tasks` - –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ –∑–∞–¥–∞—á–∏
- `/projects` - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã
- `/invoices` - –ü–æ–∫–∞–∑–∞—Ç—å —Å—á–µ—Ç–∞

### –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫ (–∫–∞–∫ –≤ –≤–µ–±-—á–∞—Ç–µ):
- "–∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?"
- "—Å–æ–∑–¥–∞–π –≤–∞–∂–Ω—É—é –∑–∞–¥–∞—á—É –∫—É–ø–∏—Ç—å –∫—Ä—ã—à–∫–∏ –¥–ª—è —à–∫–æ–ª—ã"
- "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–¥–∞—á—É –≤ –∫–≤–∞–¥—Ä–∞–Ω—Ç 1"
- "–ø–æ–∫–∞–∂–∏ –ø—Ä–æ–µ–∫—Ç—ã"
- "—Å–¥–µ–ª–∞–π —Å—Ä–æ—á–Ω–æ–π"

## 4. –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞

1. –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤—å `/start` –±–æ—Ç—É –≤ Telegram
2. –ë–æ—Ç –≤—ã–¥–∞—Å—Ç **–∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏** (6 —Ü–∏—Ñ—Ä)
3. –û—Ç–∫—Ä–æ–π –≤–µ–±-–≤–µ—Ä—Å–∏—é CRM ‚Üí –ü—Ä–æ—Ñ–∏–ª—å
4. –í–≤–µ–¥–∏ –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏
5. –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –±–æ—Ç –∑–Ω–∞–µ—Ç –∫—Ç–æ —Ç—ã

## 5. Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–¥–ª—è production)

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –≤—ã–ø–æ–ª–Ω–∏ –æ–¥–∏–Ω —Ä–∞–∑:

```bash
curl -X POST "https://api.telegram.org/bot<–¢–í–û–ô_–¢–û–ö–ï–ù>/setWebhook" \
  -d "url=https://alu.stella-spb.ru/api/telegram/webhook"
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ webhook:
```bash
curl "https://api.telegram.org/bot<–¢–í–û–ô_–¢–û–ö–ï–ù>/getWebhookInfo"
```

## 6. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏ ngrok

**Windows (—á–µ—Ä–µ–∑ Chocolatey):**
```powershell
choco install ngrok
```

**–ò–ª–∏ —Å–∫–∞—á–∞–π –≤—Ä—É—á–Ω—É—é:**
1. –°–∫–∞—á–∞–π —Å https://ngrok.com/download
2. –†–∞—Å–ø–∞–∫—É–π –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
3. –î–æ–±–∞–≤—å –≤ PATH –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–π –∏–∑ –ø–∞–ø–∫–∏

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏ dev —Å–µ—Ä–≤–µ—Ä
```powershell
npm run dev
# –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:3000
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏ ngrok (–≤ –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
```powershell
ngrok http 3000
```

–¢—ã —É–≤–∏–¥–∏—à—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–µ:
```
Forwarding  https://abc123.ngrok-free.app -> http://localhost:3000
```

**–°–ö–û–ü–ò–†–£–ô https URL** (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://abc123.ngrok-free.app`)

### –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∏ webhook
```powershell
# –ó–∞–º–µ–Ω–∏ <–¢–í–û–ô_–¢–û–ö–ï–ù> –∏ <NGROK_URL>
curl -X POST "https://api.telegram.org/bot<–¢–í–û–ô_–¢–û–ö–ï–ù>/setWebhook" -d "url=<NGROK_URL>/api/telegram/webhook"
```

**–ü—Ä–∏–º–µ—Ä:**
```powershell
curl -X POST "https://api.telegram.org/bot1234567890:ABCdefGHI/setWebhook" -d "url=https://abc123.ngrok-free.app/api/telegram/webhook"
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—å webhook
```powershell
curl "https://api.telegram.org/bot<–¢–í–û–ô_–¢–û–ö–ï–ù>/getWebhookInfo"
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
```json
{
  "ok": true,
  "result": {
    "url": "https://abc123.ngrok-free.app/api/telegram/webhook",
    "has_custom_certificate": false,
    "pending_update_count": 0
  }
}
```

### –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä—É–π –±–æ—Ç–∞!

1. –ù–∞–π–¥–∏ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram (–ø–æ username –∏–∑ BotFather)
2. –û—Ç–ø—Ä–∞–≤—å `/start`
3. –ü–æ–ª—É—á–∏ –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏
4. **–ë–ï–ó –ø—Ä–∏–≤—è–∑–∫–∏ –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç:** "‚ùå –í–∞—à Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É CRM"

### –®–∞–≥ 7: –í—ã–ø–æ–ª–Ω–∏ SQL –º–∏–≥—Ä–∞—Ü–∏—é
```sql
-- –°–∫–æ–ø–∏—Ä—É–π –∏–∑ add-telegram-support.sql –≤ Supabase SQL Editor
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS telegram_id BIGINT UNIQUE;
-- ... –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ —Ñ–∞–π–ª–∞
```

### –®–∞–≥ 8: –ü—Ä–∏–≤—è–∂–∏ –∞–∫–∫–∞—É–Ω—Ç (2 —Å–ø–æ—Å–æ–±–∞)

#### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ SQL –Ω–∞–ø—Ä—è–º—É—é (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```sql
-- –ù–∞–π–¥–∏ —Å–≤–æ–π user_id
SELECT id, email FROM auth.users WHERE email = '—Ç–≤–æ–π@email.com';

-- –í—Å—Ç–∞–≤—å telegram_id –≤—Ä—É—á–Ω—É—é
UPDATE profiles 
SET telegram_id = 123456789  -- –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π Telegram ID
WHERE id = '—Ç–≤–æ–π-user-id';
```

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Telegram ID?**
1. –ù–∞–ø–∏—à–∏ –±–æ—Ç—É @userinfobot –≤ Telegram
2. –û–Ω –ø–æ–∫–∞–∂–µ—Ç —Ç–≤–æ–π ID

#### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏ (–∫–∞–∫ –∑–∞–¥—É–º–∞–Ω–æ)
1. –û—Ç–ø—Ä–∞–≤—å `/start` –±–æ—Ç—É ‚Üí –ø–æ–ª—É—á–∏ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456)
2. –í SQL:
```sql
UPDATE profiles 
SET telegram_link_code = '123456',
    telegram_link_code_expires_at = NOW() + INTERVAL '10 minutes'
WHERE id = '—Ç–≤–æ–π-user-id';
```
3. –ó–∞—Ç–µ–º –≤ –∫–æ–¥–µ —Å–æ–∑–¥–∞–π API endpoint `/api/telegram/link` –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏

### –®–∞–≥ 9: –¢–µ—Å—Ç–∏—Ä—É–π –∫–æ–º–∞–Ω–¥—ã!

–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –ø–∏—à–∏ –±–æ—Ç—É:
- `/tasks` - –ü–æ–∫–∞–∂–µ—Ç –∑–∞–¥–∞—á–∏
- "–∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?"
- "—Å–æ–∑–¥–∞–π –≤–∞–∂–Ω—É—é –∑–∞–¥–∞—á—É –∫—É–ø–∏—Ç—å –∫—Ä—ã—à–∫–∏"
- "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –∫–≤–∞–¥—Ä–∞–Ω—Ç 1"

### Troubleshooting

**–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç?**
1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω `npm run dev`
2. –ü—Ä–æ–≤–µ—Ä—å webhook: `curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo`
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ ngrok —Ä–∞–±–æ—Ç–∞–µ—Ç: –æ—Ç–∫—Ä–æ–π `https://abc123.ngrok-free.app/api/telegram/webhook` –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å JSON —Å status: ok)

**"Certificate verify failed"?**
–ï—Å–ª–∏ Telegram —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ngrok - –¥–æ–±–∞–≤—å —Ñ–ª–∞–≥:
```powershell
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" -d "url=<NGROK_URL>/api/telegram/webhook&drop_pending_updates=true"
```

**–£–¥–∞–ª–∏—Ç—å webhook:**
```powershell
curl -X POST "https://api.telegram.org/bot<TOKEN>/deleteWebhook"
```

## –ì–æ—Ç–æ–≤–æ! üéâ

–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ Telegram —Å —Ç–µ–º–∏ –∂–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —á—Ç–æ –∏ –≤–µ–±-—á–∞—Ç.
