# üìÅ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –ö–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Å–≤–æ—é —Ñ–∞–π–ª–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–æ–∫, –∑–∞–≥—Ä—É–∑–∫–∏, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
invoice-files/                    # Supabase Storage bucket
‚îú‚îÄ‚îÄ invoices/                     # –°—á–µ—Ç–∞ (–æ–±—â–∏–µ)
‚îÇ   ‚îî‚îÄ‚îÄ {–Ω–æ–º–µ—Ä}_{–¥–∞—Ç–∞}_{timestamp}.{ext}
‚îî‚îÄ‚îÄ projects/                     # –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–æ–≤
    ‚îî‚îÄ‚îÄ {project-id}/
        ‚îú‚îÄ‚îÄ photos/               # –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        ‚îú‚îÄ‚îÄ documents/            # –î–æ–∫—É–º–µ–Ω—Ç—ã
        ‚îú‚îÄ‚îÄ invoices/             # –°—á–µ—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
        ‚îî‚îÄ‚îÄ other/                # –ü—Ä–æ—á–µ–µ
```

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª**: `migrations/create-project-files-table.sql`

–¢–∞–±–ª–∏—Ü–∞ `project_files` —Ö—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:
- `id` - UUID —Ñ–∞–π–ª–∞
- `project_id` - ID –ø—Ä–æ–µ–∫—Ç–∞
- `file_name` - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- `file_path` - –ü—É—Ç—å –≤ Storage
- `file_size` - –†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
- `file_type` - MIME —Ç–∏–ø
- `folder` - –ü–∞–ø–∫–∞ (photos, documents –∏ —Ç.–¥.)
- `uploaded_by` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `public_url` - –ü—É–±–ª–∏—á–Ω—ã–π URL
- `created_at` / `updated_at` - –î–∞—Ç—ã

### 2. API Endpoints
**–§–∞–π–ª**: `src/app/api/projects/[id]/files/route.ts`

- `GET /api/projects/[id]/files` - –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
  - –ü–∞—Ä–∞–º–µ—Ç—Ä `?folder=photos` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–∞–ø–∫–µ
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–π–ª—ã –∏ —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫

- `POST /api/projects/[id]/files` - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
  - FormData: `file`, `folder`, `user_id`
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å URL

- `DELETE /api/projects/[id]/files?file_id={id}` - –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
  - –£–¥–∞–ª—è–µ—Ç –∏–∑ Storage –∏ –ë–î

### 3. React Hook
**–§–∞–π–ª**: `src/hooks/useProjectFiles.ts`

```tsx
const { files, folders, loading, error, uploadFile, deleteFile, refresh } = 
  useProjectFiles(projectId, folder);
```

–ú–µ—Ç–æ–¥—ã:
- `uploadFile(file, folder?, userId?)` - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
- `deleteFile(fileId)` - –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
- `refresh()` - –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫

### 4. UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç
**–§–∞–π–ª**: `src/components/ProjectFileManager.tsx`

```tsx
<ProjectFileManager projectId="..." userId="..." />
```

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (drag & drop –≤ –±—É–¥—É—â–µ–º)
- üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫
- üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- ‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- üîç –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–∞–ø–∫–∞–º
- üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω

### 5. –¢–∏–ø—ã TypeScript
**–§–∞–π–ª**: `src/types/project-file.ts`

```tsx
interface ProjectFile {
  id: string;
  project_id: string;
  file_name: string;
  file_path: string;
  file_size: number;
  file_type: string;
  folder: string | null;
  uploaded_by: string | null;
  created_at: string;
  updated_at: string;
  public_url: string;
}
```

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase SQL Editor:

```bash
cat setup-project-files.sql | pbcopy
# –í—Å—Ç–∞–≤–∏—Ç—å –≤ Supabase SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª `setup-project-files.sql`.

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å Storage –ø–æ–ª–∏—Ç–∏–∫–∏

–ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ø–∞–ø–∫–∏ `projects/*` —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ bucket `invoice-files`.

### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–°–º. —Ñ–∞–π–ª `docs/project-files-integration.md` –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–µ–∫—Ç–∞.

## üíæ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤

### –î–æ–∫—É–º–µ–Ω—Ç—ã
- PDF (.pdf)
- Word (.doc, .docx)
- Excel (.xls, .xlsx, .xlsm)
- Text (.txt)

### –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)

### –ê—Ä—Ö–∏–≤—ã
- ZIP (.zip)
- RAR (.rar)
- 7-Zip (.7z)

### –î—Ä—É–≥–∏–µ
- –õ—é–±—ã–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ `application/octet-stream`

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø –∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º
- ‚úÖ Storage bucket –ø—É–±–ª–∏—á–Ω—ã–π —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- ‚úÖ –§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ (timestamp + sanitized name)

## üìä –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### Free Plan Supabase
- 1 GB Storage
- 2 GB —Ç—Ä–∞—Ñ–∏–∫–∞/–º–µ—Å—è—Ü

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –°–∂–∏–º–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PDF –≤–º–µ—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–µ–∫—Ç—ã

## üõ†Ô∏è API –ü—Ä–∏–º–µ—Ä—ã

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞

```typescript
const formData = new FormData();
formData.append('file', file);
formData.append('folder', 'photos');
formData.append('user_id', userId);

const response = await fetch(`/api/projects/${projectId}/files`, {
  method: 'POST',
  body: formData
});

const data = await response.json();
if (data.success) {
  console.log('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω:', data.file.public_url);
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤

```typescript
const response = await fetch(`/api/projects/${projectId}/files?folder=photos`);
const data = await response.json();

console.log('–§–∞–π–ª—ã:', data.files);
console.log('–ü–∞–ø–∫–∏:', data.folders);
```

### –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞

```typescript
const response = await fetch(
  `/api/projects/${projectId}/files?file_id=${fileId}`,
  { method: 'DELETE' }
);

const data = await response.json();
if (data.success) {
  console.log('–§–∞–π–ª —É–¥–∞–ª–µ–Ω');
}
```

## üé® –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤

–í `src/app/api/projects/[id]/files/route.ts`:

```typescript
const mimeTypeMap: Record<string, string> = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
  'dwg': 'application/acad',
  'svg': 'image/svg+xml',
};
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ —Ñ–∞–π–ª–æ–≤

–í `src/components/ProjectFileManager.tsx`:

```tsx
const getFileIcon = (fileType: string) => {
  if (fileType.startsWith('image/')) return <Image />;
  if (fileType.includes('pdf')) return <FileText />;
  // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã
  if (fileType.includes('video/')) return <Video />;
  return <File />;
};
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```tsx
{file.file_type.startsWith('image/') && (
  <img 
    src={file.public_url} 
    alt={file.file_name}
    className="w-full h-48 object-cover rounded"
  />
)}
```

## üìà –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] Drag & drop –∑–∞–≥—Ä—É–∑–∫–∞
- [ ] –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
- [ ] –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
- [ ] –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª–∞–º
- [ ] –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–ø–æ –∏–º–µ–Ω–∏, –¥–∞—Ç–µ, —Ä–∞–∑–º–µ—Ä—É)
- [ ] –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- [ ] –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- [ ] –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–∞–ø–∫–∞–º–∏
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤
- [ ] –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- [ ] –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–∞–ø–æ–∫
- [ ] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ñ–∞–π–ª–∞–º
- [ ] –¢–µ–≥–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- –ü–∞–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞
- –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `pm2 logs crm-glazing`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `project_files` –≤ Supabase
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Storage bucket `invoice-files`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏

## üìù Changelog

### v1.0.0 (2025-11-12)
- ‚úÖ –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–∞–ø–∫–∞–º
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Supabase Storage
