<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞ —Å—á–µ—Ç–æ–≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pattern-item { transition: all 0.3s ease; }
        .pattern-item:hover { background-color: #f9fafb; }
        .priority-1 { border-left: 4px solid #10b981; }
        .priority-2 { border-left: 4px solid #3b82f6; }
        .priority-3 { border-left: 4px solid #f59e0b; }
        .priority-4 { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">üß† –î–æ–æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞ —Å—á–µ—Ç–æ–≤</h1>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-green-100 p-4 rounded-lg">
                    <div class="text-green-800 text-sm font-medium">–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞</div>
                    <div class="text-2xl font-bold text-green-900" id="invoice-patterns-count">11</div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg">
                    <div class="text-blue-800 text-sm font-medium">–°—É–º–º–∞ —Å—á–µ—Ç–∞</div>
                    <div class="text-2xl font-bold text-blue-900" id="amount-patterns-count">7</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg">
                    <div class="text-purple-800 text-sm font-medium">–ü–æ—Å—Ç–∞–≤—â–∏–∫</div>
                    <div class="text-2xl font-bold text-purple-900" id="contractor-patterns-count">4</div>
                </div>
                <div class="bg-orange-100 p-4 rounded-lg">
                    <div class="text-orange-800 text-sm font-medium">–ò–ù–ù</div>
                    <div class="text-2xl font-bold text-orange-900" id="inn-patterns-count">5</div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button class="tab-button active py-2 px-1 border-b-2 font-medium text-sm" data-tab="invoice-number">
                        –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞
                    </button>
                    <button class="tab-button py-2 px-1 border-b-2 font-medium text-sm" data-tab="total-amount">
                        –°—É–º–º–∞ —Å—á–µ—Ç–∞
                    </button>
                    <button class="tab-button py-2 px-1 border-b-2 font-medium text-sm" data-tab="contractor-name">
                        –ü–æ—Å—Ç–∞–≤—â–∏–∫
                    </button>
                    <button class="tab-button py-2 px-1 border-b-2 font-medium text-sm" data-tab="inn">
                        –ò–ù–ù
                    </button>
                    <button class="tab-button py-2 px-1 border-b-2 font-medium text-sm" data-tab="test">
                        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                    </button>
                    <button class="tab-button py-2 px-1 border-b-2 font-medium text-sm" data-tab="training-stats">
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è
                    </button>
                </nav>
            </div>

            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
            <div id="invoice-number" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">–ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–∞</h2>
                    <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="addPattern('invoice-number')">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
                    </button>
                </div>
                <div id="invoice-number-patterns" class="space-y-3">
                    <!-- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div id="total-amount" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">–ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É–º–º—ã —Å—á–µ—Ç–∞</h2>
                    <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="addPattern('total-amount')">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
                    </button>
                </div>
                <div id="total-amount-patterns" class="space-y-3">
                    <!-- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div id="contractor-name" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">–ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</h2>
                    <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="addPattern('contractor-name')">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
                    </button>
                </div>
                <div id="contractor-name-patterns" class="space-y-3">
                    <!-- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div id="inn" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">–ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</h2>
                    <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="addPattern('inn')">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
                    </button>
                </div>
                <div id="inn-patterns" class="space-y-3">
                    <!-- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div id="test" class="tab-content hidden">
                <h2 class="text-xl font-semibold mb-4">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞</h2>
                
                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-medium mb-3">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>
                    <div class="space-y-4">
                        <div>
                            <input type="file" id="invoice-file" accept=".pdf,.xlsx,.xls,.docx,.doc" 
                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <p class="text-sm text-gray-500 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, Excel (.xlsx, .xls), Word (.docx, .doc)</p>
                        </div>
                        <div class="flex space-x-3">
                            <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="uploadAndAnalyze()">
                                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" onclick="clearResults()">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                        <div id="upload-status" class="text-sm"></div>
                    </div>
                </div>

                <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium mb-3">‚úèÔ∏è –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–∫—Å—Ç —Å—á–µ—Ç–∞:</label>
                            <textarea id="test-text" class="w-full h-32 p-3 border border-gray-300 rounded-md" 
                                      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç —Å—á–µ—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
                        </div>
                        <button class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600" onclick="testParser()">
                            üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
                        </button>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
                <div id="analysis-results" class="hidden">
                    <h3 class="text-lg font-medium mb-4">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
                    
                    <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="font-medium text-blue-900 mb-3">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:</h4>
                        <div id="auto-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <h4 class="font-medium text-yellow-900 mb-3">‚úèÔ∏è –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞:</label>
                                <input type="text" id="correct-number" class="w-full p-2 border border-gray-300 rounded" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ —Å—á–µ—Ç–∞:</label>
                                <input type="date" id="correct-date" class="w-full p-2 border border-gray-300 rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–°—É–º–º–∞ —Å—á–µ—Ç–∞:</label>
                                <input type="number" id="correct-amount" step="0.01" class="w-full p-2 border border-gray-300 rounded" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:</label>
                                <input type="text" id="correct-inn" class="w-full p-2 border border-gray-300 rounded" placeholder="1234567890">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:</label>
                                <input type="text" id="correct-contractor" class="w-full p-2 border border-gray-300 rounded" placeholder="–û–û–û '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏'">
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-3">
                            <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="saveTrainingData()">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —ç—Ç–∞–ª–æ–Ω
                            </button>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="improvePatterns()">
                                üîß –£–ª—É—á—à–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                            </button>
                        </div>
                    </div>

                    <!-- –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç -->
                    <div class="bg-gray-50 border rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-3">üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:</h4>
                        <div class="bg-white p-3 rounded border max-h-64 overflow-y-auto">
                            <pre id="source-text" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div id="test-results" class="mt-4"></div>
            </div>

            <div id="training-stats" class="tab-content hidden">
                <h2 class="text-xl font-semibold mb-4">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞</h2>
                
                <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <div class="text-blue-800 text-sm font-medium">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                        <div class="text-2xl font-bold text-blue-900" id="total-training-records">0</div>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <div class="text-green-800 text-sm font-medium">–û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (80%+)</div>
                        <div class="text-2xl font-bold text-green-900" id="excellent-records">0</div>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg">
                        <div class="text-yellow-800 text-sm font-medium">–•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ (50-79%)</div>
                        <div class="text-2xl font-bold text-yellow-900" id="good-records">0</div>
                    </div>
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="flex space-x-4 mb-6">
                    <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="loadTrainingStats()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    </button>
                    <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="exportTrainingData()">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </button>
                    <button class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600" onclick="retrainModel()">
                        üß† –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å
                    </button>
                </div>

                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
                <div class="bg-white border rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—É—á–∞—é—â–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                    <div id="recent-training-records">
                        <p class="text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="mt-8 flex space-x-4">
                <button class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600" onclick="saveRules()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
                </button>
                <button class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600" onclick="loadRules()">
                    üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
                </button>
                <button class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600" onclick="resetRules()">
                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—é
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ -->
    <div id="pattern-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <input type="text" id="pattern-description" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:</label>
                    <textarea id="pattern-regex" class="w-full p-2 border border-gray-300 rounded h-20"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-4):</label>
                    <select id="pattern-priority" class="w-full p-2 border border-gray-300 rounded">
                        <option value="1">1 - –í—ã—Å–æ–∫–∏–π</option>
                        <option value="2">2 - –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="3">3 - –ù–∏–∑–∫–∏–π</option>
                        <option value="4">4 - –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-4 mt-6">
                <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="saveNewPattern()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" onclick="closeModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentRules = {};
        let currentPatternType = '';
        let currentAnalysisData = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            loadRules();
            setupTabs();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞
        async function uploadAndAnalyze() {
            const fileInput = document.getElementById('invoice-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }

            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = '<div class="text-blue-600">üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª...</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/smart-invoice', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentAnalysisData = result;
                    displayAnalysisResults(result);
                    statusDiv.innerHTML = '<div class="text-green-600">‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</div>';
                } else {
                    statusDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
        function displayAnalysisResults(data) {
            const resultsDiv = document.getElementById('analysis-results');
            const autoResultsDiv = document.getElementById('auto-results');
            const sourceTextDiv = document.getElementById('source-text');

            resultsDiv.classList.remove('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const invoice = data.data?.invoice || {};
            const contractor = data.data?.contractor || {};

            autoResultsDiv.innerHTML = `
                <div class="space-y-2">
                    <div><span class="font-medium">–ù–æ–º–µ—Ä:</span> ${invoice.number || '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</div>
                    <div><span class="font-medium">–î–∞—Ç–∞:</span> ${invoice.date || '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞'}</div>
                    <div><span class="font-medium">–°—É–º–º–∞:</span> ${invoice.total_amount ? invoice.total_amount + ' —Ä—É–±.' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞'}</div>
                </div>
                <div class="space-y-2">
                    <div><span class="font-medium">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</span> ${contractor.name || '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</div>
                    <div><span class="font-medium">–ò–ù–ù:</span> ${contractor.inn || '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω'}</div>
                </div>
            `;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            document.getElementById('correct-number').value = invoice.number || '';
            document.getElementById('correct-date').value = invoice.date || '';
            document.getElementById('correct-amount').value = invoice.total_amount || '';
            document.getElementById('correct-contractor').value = contractor.name || '';
            document.getElementById('correct-inn').value = contractor.inn || '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
            sourceTextDiv.textContent = data.ocr_text || '–¢–µ–∫—Å—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        async function saveTrainingData() {
            if (!currentAnalysisData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            const trainingData = {
                source_text: currentAnalysisData.ocr_text,
                correct_data: {
                    invoice_number: document.getElementById('correct-number').value,
                    invoice_date: document.getElementById('correct-date').value,
                    total_amount: parseFloat(document.getElementById('correct-amount').value) || null,
                    contractor_name: document.getElementById('correct-contractor').value,
                    contractor_inn: document.getElementById('correct-inn').value
                },
                auto_detected: currentAnalysisData.data,
                file_name: currentAnalysisData.file_info?.name || 'unknown'
            };

            try {
                const response = await fetch('/api/save-training-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(trainingData)
                });

                if (response.ok) {
                    alert('‚úÖ –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –æ–±—É—á–µ–Ω–∏—è!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –£–ª—É—á—à–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
        async function improvePatterns() {
            if (!currentAnalysisData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            const sourceText = currentAnalysisData.ocr_text;
            const correctNumber = document.getElementById('correct-number').value;
            const correctAmount = document.getElementById('correct-amount').value;
            const correctContractor = document.getElementById('correct-contractor').value;
            const correctInn = document.getElementById('correct-inn').value;

            const suggestions = [];

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞
            if (correctNumber && sourceText.includes(correctNumber)) {
                const context = extractContext(sourceText, correctNumber);
                suggestions.push({
                    type: 'invoice_number',
                    pattern: generatePattern(context, correctNumber),
                    description: `–ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –Ω–æ–º–µ—Ä–∞ ${correctNumber}`,
                    priority: 1
                });
            }

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—É–º–º—É
            if (correctAmount && sourceText.includes(correctAmount)) {
                const context = extractContext(sourceText, correctAmount);
                suggestions.push({
                    type: 'total_amount',
                    pattern: generateAmountPattern(context, correctAmount),
                    description: `–ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —Å—É–º–º—ã ${correctAmount}`,
                    priority: 1
                });
            }

            if (suggestions.length > 0) {
                showPatternSuggestions(suggestions);
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤');
            }
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ–∫—Ä—É–≥ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        function extractContext(text, value, contextLength = 50) {
            const index = text.indexOf(value);
            if (index === -1) return null;
            
            const start = Math.max(0, index - contextLength);
            const end = Math.min(text.length, index + value.length + contextLength);
            
            return {
                before: text.substring(start, index),
                value: value,
                after: text.substring(index + value.length, end),
                fullContext: text.substring(start, end)
            };
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        function generatePattern(context, value) {
            if (!context) return null;
            
            // –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            const before = context.before.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').trim();
            const after = context.after.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').trim();
            
            return `${before}\\s*([^\\s]+)\\s*${after}`;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è —Å—É–º–º—ã
        function generateAmountPattern(context, amount) {
            if (!context) return null;
            
            const before = context.before.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').trim();
            return `${before}\\s*([0-9]{1,}(?:[\\s,\\.][0-9]{3})*[\\.,]\\d{2})`;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        function showPatternSuggestions(suggestions) {
            let html = '<div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">';
            html += '<h4 class="font-medium text-green-900 mb-3">üí° –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:</h4>';
            
            suggestions.forEach((suggestion, index) => {
                html += `
                    <div class="bg-white p-3 rounded border mb-2">
                        <div class="font-medium">${suggestion.description}</div>
                        <code class="text-sm text-gray-600 bg-gray-100 p-1 rounded block mt-1">${suggestion.pattern}</code>
                        <button class="mt-2 bg-green-500 text-white px-3 py-1 text-sm rounded hover:bg-green-600" 
                                onclick="applySuggestedPattern(${index}, '${suggestion.type}', '${suggestion.pattern}', '${suggestion.description}', ${suggestion.priority})">
                            ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('analysis-results').insertAdjacentHTML('beforeend', html);
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
        function applySuggestedPattern(index, type, pattern, description, priority) {
            const typeKey = `${type}_patterns`;
            if (!currentRules[typeKey]) {
                currentRules[typeKey] = [];
            }

            currentRules[typeKey].unshift({
                pattern: pattern,
                priority: priority,
                description: description + ' (–∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)',
                active: true
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            currentRules[typeKey].sort((a, b) => a.priority - b.priority);

            renderPatterns();
            alert('‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω –¥–æ–±–∞–≤–ª–µ–Ω! –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞.');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è
        async function loadTrainingStats() {
            try {
                const response = await fetch('/api/save-training-data');
                const stats = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('total-training-records').textContent = stats.total_records || 0;
                document.getElementById('excellent-records').textContent = stats.records_by_quality?.excellent || 0;
                document.getElementById('good-records').textContent = stats.records_by_quality?.good || 0;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
                displayRecentRecords(stats.recent_records || []);
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π
        function displayRecentRecords(records) {
            const container = document.getElementById('recent-training-records');
            
            if (records.length === 0) {
                container.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –æ–±—É—á–∞—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π</p>';
                return;
            }
            
            const html = records.map(record => `
                <div class="border-b border-gray-200 py-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-900">${record.file_name}</div>
                            <div class="text-xs text-gray-500">${new Date(record.timestamp).toLocaleString('ru-RU')}</div>
                            <div class="text-sm text-gray-700 mt-1">
                                <span class="font-medium">–ù–æ–º–µ—Ä:</span> ${record.correct_data.invoice_number || '–ù–µ —É–∫–∞–∑–∞–Ω'} | 
                                <span class="font-medium">–°—É–º–º–∞:</span> ${record.correct_data.total_amount || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} | 
                                <span class="font-medium">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</span> ${record.correct_data.contractor_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                            </div>
                        </div>
                        <div class="ml-4">
                            <span class="px-2 py-1 text-xs rounded ${getQualityClass(record.quality_score)}">
                                ${record.quality_score || 0}%
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ CSS –∫–ª–∞—Å—Å–∞ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
        function getQualityClass(score) {
            if (score >= 80) return 'bg-green-100 text-green-800';
            if (score >= 50) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        async function exportTrainingData() {
            try {
                window.open('/api/save-training-data?export=true', '_blank');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
            }
        }

        // –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
        async function retrainModel() {
            if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/retrain-model', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function setupTabs() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    showTab(tabName);
                });
            });
        }

        function showTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.remove('hidden');
            
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }

        async function loadRules() {
            try {
                const response = await fetch('/parser_rules.json');
                if (!response.ok) {
                    console.log('–§–∞–π–ª –ø—Ä–∞–≤–∏–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—ë–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞');
                    createDefaultRules();
                    return;
                }
                currentRules = await response.json();
                renderPatterns();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª:', error);
                createDefaultRules();
            }
        }

        function createDefaultRules() {
            // –°–æ–∑–¥–∞—ë–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            currentRules = {
                invoice_number_patterns: [
                    {
                        pattern: "‚Ññ\\\\s*([–ê-–Ø–ÅA-Z]+-\\\\d+)",
                        priority: 1,
                        description: "–ë—É–∫–≤–µ–Ω–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ (–£–¢-784, –ê-123)",
                        active: true
                    }
                ],
                total_amount_patterns: [
                    {
                        pattern: "(?:–≤—Å–µ–≥–æ\\\\s*–∫\\\\s*–æ–ø–ª–∞—Ç–µ|–í–°–ï–ì–û\\\\s*–ö\\\\s*–û–ü–õ–ê–¢–ï)[\\\\s:]*([0-9]{1,3}(?:[\\\\s,\\\\.][0-9]{3})*[\\\\.,]\\\\d{2})",
                        priority: 1,
                        description: "–í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ",
                        active: true
                    }
                ],
                contractor_name_patterns: [
                    {
                        pattern: "–ü–æ—Å—Ç–∞–≤—â–∏–∫:\\\\s*([^\\\\n\\\\r,]+?)(?:,|\\\\s*–ò–ù–ù|\\\\s*–ö–ü–ü|\\\\s*–ê–¥—Ä–µ—Å:|\\\\s*—Ç–µ–ª\\\\.|\\\\s*$)",
                        priority: 1,
                        description: "–ü–æ—Å—Ç–∞–≤—â–∏–∫: –ù–ê–ó–í–ê–ù–ò–ï",
                        active: true
                    }
                ],
                inn_patterns: [
                    {
                        pattern: "–ò–ù–ù[\\\\s:]*(\\\\d{10,12})",
                        priority: 2,
                        description: "–õ—é–±–æ–π –ò–ù–ù",
                        active: true
                    }
                ]
            };
            renderPatterns();
        }

        function renderPatterns() {
            renderPatternType('invoice_number');
            renderPatternType('total_amount');
            renderPatternType('contractor_name');
            renderPatternType('inn');
            updateStats();
        }

        function renderPatternType(type) {
            const container = document.getElementById(`${type.replace('_', '-')}-patterns`);
            const patterns = currentRules[`${type}_patterns`] || [];
            
            container.innerHTML = patterns.map((pattern, index) => `
                <div class="pattern-item p-4 border rounded-lg priority-${pattern.priority} ${pattern.active ? '' : 'opacity-50'}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-sm font-medium text-gray-600">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ${pattern.priority}</span>
                                <span class="text-xs px-2 py-1 rounded ${pattern.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${pattern.active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω'}
                                </span>
                            </div>
                            <h4 class="font-medium text-gray-900">${pattern.description}</h4>
                            <code class="text-sm text-gray-600 bg-gray-100 p-1 rounded block mt-1">${pattern.pattern}</code>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button class="px-3 py-1 text-sm rounded ${pattern.active ? 'bg-red-100 text-red-800 hover:bg-red-200' : 'bg-green-100 text-green-800 hover:bg-green-200'}" 
                                    onclick="togglePattern('${type}', ${index})">
                                ${pattern.active ? '–û—Ç–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}
                            </button>
                            <button class="px-3 py-1 text-sm bg-red-100 text-red-800 rounded hover:bg-red-200" 
                                    onclick="deletePattern('${type}', ${index})">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('invoice-patterns-count').textContent = currentRules.invoice_number_patterns?.length || 0;
            document.getElementById('amount-patterns-count').textContent = currentRules.total_amount_patterns?.length || 0;
            document.getElementById('contractor-patterns-count').textContent = currentRules.contractor_name_patterns?.length || 0;
            document.getElementById('inn-patterns-count').textContent = currentRules.inn_patterns?.length || 0;
        }

        function addPattern(type) {
            currentPatternType = type;
            document.getElementById('pattern-modal').classList.remove('hidden');
            document.getElementById('pattern-modal').classList.add('flex');
            
            // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è
            document.getElementById('pattern-description').value = '';
            document.getElementById('pattern-regex').value = '';
            document.getElementById('pattern-priority').value = '1';
        }

        function closeModal() {
            document.getElementById('pattern-modal').classList.add('hidden');
            document.getElementById('pattern-modal').classList.remove('flex');
        }

        function saveNewPattern() {
            const description = document.getElementById('pattern-description').value;
            const pattern = document.getElementById('pattern-regex').value;
            const priority = parseInt(document.getElementById('pattern-priority').value);

            if (!description || !pattern) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const typeKey = `${currentPatternType.replace('-', '_')}_patterns`;
            if (!currentRules[typeKey]) {
                currentRules[typeKey] = [];
            }

            currentRules[typeKey].push({
                pattern: pattern,
                priority: priority,
                description: description,
                active: true
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            currentRules[typeKey].sort((a, b) => a.priority - b.priority);

            renderPatterns();
            closeModal();
        }

        function togglePattern(type, index) {
            const typeKey = `${type}_patterns`;
            currentRules[typeKey][index].active = !currentRules[typeKey][index].active;
            renderPatterns();
        }

        function deletePattern(type, index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω?')) {
                const typeKey = `${type}_patterns`;
                currentRules[typeKey].splice(index, 1);
                renderPatterns();
            }
        }

        async function saveRules() {
            try {
                const response = await fetch('/api/save-parser-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentRules)
                });
                
                if (response.ok) {
                    alert('‚úÖ –ü—Ä–∞–≤–∏–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function testParser() {
            const text = document.getElementById('test-text').value;
            if (!text.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            try {
                const response = await fetch('/api/test-parser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                const result = await response.json();
                
                if (result.success !== false) {
                    // –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –æ–∂–∏–¥–∞–µ–º–æ–º displayAnalysisResults
                    const analysisData = {
                        data: {
                            invoice: {
                                number: result.invoice_number,
                                date: result.invoice_date,
                                total_amount: result.total_amount
                            },
                            contractor: {
                                name: result.contractor_name,
                                inn: result.contractor_inn
                            }
                        },
                        ocr_text: text,
                        file_info: { name: 'manual_input.txt' }
                    };
                    
                    currentAnalysisData = analysisData;
                    displayAnalysisResults(analysisData);
                } else {
                    displayTestResults(result);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
            }
        }

        function displayTestResults(result) {
            const container = document.getElementById('test-results');
            container.innerHTML = `
                <div class="bg-gray-100 rounded-lg p-4">
                    <h3 class="font-semibold mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
                    <div class="space-y-2">
                        <div><strong>–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞:</strong> ${result.invoice_number || '–ù–µ –Ω–∞–π–¥–µ–Ω'}</div>
                        <div><strong>–î–∞—Ç–∞:</strong> ${result.invoice_date || '–ù–µ –Ω–∞–π–¥–µ–Ω–∞'}</div>
                        <div><strong>–°—É–º–º–∞:</strong> ${result.total_amount || '–ù–µ –Ω–∞–π–¥–µ–Ω–∞'}</div>
                        <div><strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> ${result.contractor_name || '–ù–µ –Ω–∞–π–¥–µ–Ω'}</div>
                        <div><strong>–ò–ù–ù:</strong> ${result.contractor_inn || '–ù–µ –Ω–∞–π–¥–µ–Ω'}</div>
                    </div>
                </div>
            `;
        }

        function resetRules() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                createDefaultRules();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function clearResults() {
            document.getElementById('analysis-results').classList.add('hidden');
            document.getElementById('upload-status').innerHTML = '';
            document.getElementById('invoice-file').value = '';
            document.getElementById('test-text').value = '';
            currentAnalysisData = null;
        }
    </script>
</body>
</html>