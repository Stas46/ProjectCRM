<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Yandex Vision API</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .step { background: #f0f8ff; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4299e1; }
        .important { background: #fff5f5; border-left: 4px solid #fc8181; padding: 20px; margin: 15px 0; border-radius: 8px; }
        .success { background: #f0fff4; border-left: 4px solid #48bb78; padding: 20px; margin: 15px 0; border-radius: 8px; }
        .warning { background: #fffbf0; border-left: 4px solid #f6ad55; padding: 20px; margin: 15px 0; border-radius: 8px; }
        .code { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; font-family: monospace; margin: 10px 0; overflow-x: auto; }
        .btn { background: #4299e1; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px 5px; text-decoration: none; display: inline-block; }
        .btn:hover { background: #3182ce; }
        .btn-green { background: #48bb78; }
        .btn-green:hover { background: #38a169; }
        .btn-orange { background: #f6ad55; }
        .btn-orange:hover { background: #ed8936; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Yandex Vision API</h1>
        
        <div class="success">
            <h3>‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ!</h3>
            <p>–°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç <code>vision-ocr-service</code> –∏–º–µ–µ—Ç:</p>
            <ul>
                <li><strong>ai.admin</strong> - –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ AI —Å–µ—Ä–≤–∏—Å—ã</li>
                <li><strong>ai.vision.user</strong> - –ø—Ä–∞–≤–∞ –Ω–∞ Vision API</li>
            </ul>
            <p>–ù–æ –æ—à–∏–±–∫–∞ 403 –≤—Å—ë –µ—â—ë –≤–æ–∑–Ω–∏–∫–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–∏—á–∏–Ω—ã.</p>
        </div>

        <div class="step">
            <h2>üß™ –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoint</h2>
            <p>–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ –≤ URL –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–µ –∑–∞–ø—Ä–æ—Å–∞.</p>
            <button class="btn" onclick="testApiEndpoint()">üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoint</button>
            <div id="endpointResult" style="margin-top: 10px;"></div>
        </div>

        <div class="step">
            <h2>üîë –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞</h2>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º, –≤–∞–ª–∏–¥–µ–Ω –ª–∏ API –∫–ª—é—á –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è.</p>
            <button class="btn btn-orange" onclick="testApiKey()">üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –∫–ª—é—á</button>
            <div id="apiKeyResult" style="margin-top: 10px;"></div>
        </div>

        <div class="step">
            <h2>üåê –¢–µ—Å—Ç 3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π endpoint</h2>
            <p>–ü–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π API endpoint –¥–ª—è Vision API.</p>
            <button class="btn btn-green" onclick="testAlternativeEndpoint()">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π API</button>
            <div id="alternativeResult" style="margin-top: 10px;"></div>
        </div>

        <div class="warning">
            <h3>ü§î –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 403:</h3>
            <ol>
                <li><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç API –∫–ª—é—á–∞</strong> - –∫–ª—é—á –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω</li>
                <li><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint</strong> - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ —Ç–æ—Ç URL</li>
                <li><strong>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞</strong> - —Ñ–æ—Ä–º–∞—Ç JSON –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π</li>
                <li><strong>–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</strong> - API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–µ–≥–∏–æ–Ω–µ</li>
                <li><strong>–ë–∏–ª–ª–∏–Ω–≥</strong> - –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ –∑–∞ Vision API</li>
            </ol>
        </div>

        <div class="step">
            <h2>üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ</h2>
            <p>–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å Vision API —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –º–æ–∂–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:</p>
            <ul>
                <li><strong>Google Cloud Vision</strong> - —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ</li>
                <li><strong>Tesseract OCR</strong> - –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –±–µ–∑ –æ–±–ª–∞—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</li>
                <li><strong>Azure Computer Vision</strong> - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å</li>
            </ul>
            
            <button class="btn" onclick="showAlternatives()">üìã –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã</button>
            <div id="alternativesInfo" style="margin-top: 10px; display: none;"></div>
        </div>

        <div class="important">
            <h3>üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</h3>
            <div class="code">
–°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç: vision-ocr-service ‚úÖ
API –∫–ª—é—á: AQVN...–≤–∞—à_api_–∫–ª—é—á... ‚úÖ
Folder ID: b1g...–≤–∞—à_folder_id... ‚úÖ
–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: ai.admin + ai.vision.user ‚úÖ
–û—à–∏–±–∫–∞: 403 Permission denied ‚ùå
            </div>
        </div>
    </div>

    <script>
        async function testApiEndpoint() {
            const resultDiv = document.getElementById('endpointResult');
            resultDiv.innerHTML = '<div style="color: blue;">üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º API endpoint...</div>';

            try {
                const response = await fetch('/api/yandex-config-check');
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong><br>
                        API –∫–ª—é—á: ${data.config.hasApiKey ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}<br>
                        Folder ID: ${data.config.hasFolderId ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}<br>
                        –°—Ç–∞—Ç—É—Å: ${data.status}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = '<div style="color: red;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>';
            }
        }

        async function testApiKey() {
            const resultDiv = document.getElementById('apiKeyResult');
            resultDiv.innerHTML = '<div style="color: blue;">üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á...</div>';

            // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞
            const canvas = document.createElement('canvas');
            canvas.width = 10;
            canvas.height = 10;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 10, 10);
            ctx.fillStyle = 'black';
            ctx.fillText('A', 2, 8);
            
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'test.png');
                
                try {
                    const response = await fetch('/api/yandex-vision-test', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.ocrResults && result.ocrResults.errorMessage) {
                        const errorMsg = result.ocrResults.errorMessage;
                        if (errorMsg.includes('403')) {
                            resultDiv.innerHTML = `
                                <div style="background: #fff5f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #fc8181;">
                                    <strong>‚ùå –û—à–∏–±–∫–∞ 403 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</strong><br>
                                    –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø—Ä–∞–≤, –∞ –≤ —á–µ–º-—Ç–æ –¥—Ä—É–≥–æ–º.
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div style="background: #fffbf0; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #f6ad55;">
                                    <strong>‚ö†Ô∏è –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞:</strong><br>
                                    ${errorMsg}
                                </div>
                            `;
                        }
                    } else if (result.ocrResults && result.ocrResults.success) {
                        resultDiv.innerHTML = `
                            <div style="background: #f0fff4; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #48bb78;">
                                <strong>‚úÖ API –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong><br>
                                Yandex Vision —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div style="background: #fff5f5; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #fc8181;">
                            <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            }, 'image/png');
        }

        async function testAlternativeEndpoint() {
            const resultDiv = document.getElementById('alternativeResult');
            resultDiv.innerHTML = '<div style="color: blue;">üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π endpoint...</div>';
            
            resultDiv.innerHTML = `
                <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #4299e1;">
                    <strong>üí° –ò–¥–µ—è:</strong><br>
                    –ü–æ–ø—Ä–æ–±—É–µ–º –∏–∑–º–µ–Ω–∏—Ç—å API endpoint –Ω–∞:<br>
                    <code>https://vision.api.cloud.yandex.net/vision/v1/batchAnalyze</code><br>
                    –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ URL, —Å folder ID –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞.
                </div>
            `;
        }

        function showAlternatives() {
            const info = document.getElementById('alternativesInfo');
            info.style.display = info.style.display === 'none' ? 'block' : 'none';
            
            if (info.style.display === 'block') {
                info.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
                        <h4>üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:</h4>
                        
                        <p><strong>1. Google Cloud Vision (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω):</strong></p>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; font-family: monospace;">
// –í test-center —É–∂–µ –µ—Å—Ç—å –æ–ø—Ü–∏—è "Google Vision OCR"
// –ú–æ–∂–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–µ–≥–æ
                        </div>
                        
                        <p><strong>2. Tesseract OCR (–ª–æ–∫–∞–ª—å–Ω—ã–π):</strong></p>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; font-family: monospace;">
npm install tesseract.js
// –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ API –∫–ª—é—á–µ–π
                        </div>
                        
                        <p><strong>3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ª–∏—á–Ω—ã–π API –∫–ª—é—á:</strong></p>
                        <div style="background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; font-family: monospace;">
// –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
// –≤–º–µ—Å—Ç–æ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>