# üìä –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## –î–∏–∞–≥—Ä–∞–º–º–∞ —Ç–∞–±–ª–∏—Ü

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           SUPPLIERS                 ‚îÇ
‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ üîë id (UUID)                        ‚îÇ
‚îÇ üìù name (text) *required            ‚îÇ
‚îÇ üè¢ inn (text)                       ‚îÇ
‚îÇ üìû phone (text)                     ‚îÇ
‚îÇ üìß email (text)                     ‚îÇ
‚îÇ üìç legal_address (text)             ‚îÇ
‚îÇ üè∑Ô∏è  category (text)                 ‚îÇ
‚îÇ üìÖ created_at (timestamp)           ‚îÇ
‚îÇ üìÖ updated_at (timestamp)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üë
           ‚îÇ
           ‚îÇ supplier_id (FK)
           ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           INVOICES                  ‚îÇ
‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ üîë id (UUID)                        ‚îÇ
‚îÇ üîó supplier_id (UUID FK)            ‚îÇ
‚îÇ ÔøΩ project_id (UUID) - –±—É–¥—É—â–∞—è —Å–≤—è–∑—å‚îÇ
‚îÇ ÔøΩüî¢ invoice_number (text) *required  ‚îÇ
‚îÇ üìÖ invoice_date (date) *required    ‚îÇ
‚îÇ üí∞ total_amount (decimal) *required ‚îÇ
‚îÇ üßæ vat_amount (decimal)             ‚îÇ
‚îÇ üìé file_url (text) *required        ‚îÇ
‚îÇ üìÖ created_at (timestamp)           ‚îÇ
‚îÇ üìÖ updated_at (timestamp)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)

### 1Ô∏è‚É£ invoices_with_suppliers

–û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å—á–µ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:

```sql
SELECT 
  i.id,
  i.invoice_number,
  i.invoice_date,
  i.total_amount,
  i.vat_amount,
  i.file_url,
  i.created_at,
  s.id as supplier_id,
  s.name as supplier_name,
  s.inn as supplier_inn,
  s.category as supplier_category
FROM invoices i
LEFT JOIN suppliers s ON i.supplier_id = s.id
ORDER BY i.created_at DESC;
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
const { data } = await supabase
  .from('invoices_with_suppliers')
  .select('*')
  .order('created_at', { ascending: false });
```

### 2Ô∏è‚É£ supplier_totals

–°—É–º–º—ã —Å—á–µ—Ç–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ—Å—Ç–∞–≤—â–∏–∫—É:

```sql
SELECT 
  s.id,
  s.name,
  s.inn,
  s.category,
  COUNT(i.id) as invoice_count,
  COALESCE(SUM(i.total_amount), 0) as total_amount,
  COALESCE(SUM(i.vat_amount), 0) as total_vat
FROM suppliers s
LEFT JOIN invoices i ON i.supplier_id = s.id
GROUP BY s.id, s.name, s.inn, s.category
ORDER BY total_amount DESC;
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
const { data } = await supabase
  .from('supplier_totals')
  .select('*')
  .order('total_amount', { ascending: false });
```

---

## –ò–Ω–¥–µ–∫—Å—ã

### suppliers
- `idx_suppliers_inn` - –ø–æ–∏—Å–∫ –ø–æ –ò–ù–ù
- `idx_suppliers_name` - –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
- `idx_suppliers_category` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

### invoices
- `idx_invoices_supplier_id` - JOIN —Å suppliers
- `idx_invoices_project_id` - JOIN —Å projects (–±—É–¥—É—â–∞—è —Å–≤—è–∑—å)
- `idx_invoices_invoice_number` - –ø–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É
- `idx_invoices_invoice_date` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
- `idx_invoices_created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è

---

## –¢—Ä–∏–≥–≥–µ—Ä—ã

### update_updated_at_column()

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç `updated_at` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏:

```sql
CREATE TRIGGER update_suppliers_updated_at
  BEFORE UPDATE ON suppliers
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_invoices_updated_at
  BEFORE UPDATE ON invoices
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

## –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è `suppliers.category`:

- `construction` - –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ
- `materials` - –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
- `services` - –£—Å–ª—É–≥–∏
- `equipment` - –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- `transport` - –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
- `other` - –ü—Ä–æ—á–µ–µ

TypeScript enum:
```typescript
export type SupplierCategory = 
  | 'construction'
  | 'materials'
  | 'services'
  | 'equipment'
  | 'transport'
  | 'other';
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –í—Å–µ —Å—á–µ—Ç–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
```sql
SELECT * FROM invoices_with_suppliers
WHERE invoice_date >= DATE_TRUNC('month', CURRENT_DATE)
ORDER BY invoice_date DESC;
```

### –¢–æ–ø-5 –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ø–æ —Å—É–º–º–µ
```sql
SELECT * FROM supplier_totals
ORDER BY total_amount DESC
LIMIT 5;
```

### –°—á–µ—Ç–∞ –±–µ–∑ –ù–î–°
```sql
SELECT * FROM invoices
WHERE vat_amount IS NULL OR vat_amount = 0;
```

### –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –±–µ–∑ —Å—á–µ—Ç–æ–≤
```sql
SELECT * FROM supplier_totals
WHERE invoice_count = 0;
```

### –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
```sql
SELECT 
  s.category,
  COUNT(DISTINCT s.id) as supplier_count,
  COUNT(i.id) as invoice_count,
  COALESCE(SUM(i.total_amount), 0) as total
FROM suppliers s
LEFT JOIN invoices i ON i.supplier_id = s.id
GROUP BY s.category
ORDER BY total DESC;
```

---

## Storage —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
invoices/
  ‚îú‚îÄ‚îÄ {timestamp}-{random}.pdf
  ‚îú‚îÄ‚îÄ {timestamp}-{random}.jpg
  ‚îî‚îÄ‚îÄ {timestamp}-{random}.png
```

–§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞:
```
1699445678901-a3f2d9.pdf
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚î¨‚îÄ‚îò
   timestamp    random
```

---

## –†–∞–∑–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞:

| –¢–∞–±–ª–∏—Ü–∞    | –ó–∞–ø–∏—Å—å | 1,000 –∑–∞–ø–∏—Å–µ–π | 10,000 –∑–∞–ø–∏—Å–µ–π |
|------------|--------|---------------|----------------|
| suppliers  | ~500B  | ~500 KB       | ~5 MB          |
| invoices   | ~300B  | ~300 KB       | ~3 MB          |

**Storage:** 1 —Å—á–µ—Ç (PDF) ‚âà 100-500 KB

1,000 —Å—á–µ—Ç–æ–≤ ‚âà 100-500 MB

---

## –ú–∏–≥—Ä–∞—Ü–∏–∏ (–±—É–¥—É—â–µ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è:

```sql
-- –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
ALTER TABLE invoices 
ADD COLUMN payment_status TEXT DEFAULT 'pending';

-- –°–≤—è–∑—å —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –£–ñ–ï –î–û–ë–ê–í–õ–ï–ù–ê (project_id)
-- –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–¥–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É projects, –¥–æ–±–∞–≤—å—Ç–µ FK:
-- ALTER TABLE invoices 
-- ADD CONSTRAINT fk_project 
-- FOREIGN KEY (project_id) REFERENCES projects(id);

-- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏—è
ALTER TABLE suppliers 
ADD COLUMN notes TEXT;
```
