#!/usr/bin/env python3
import requests
import json
import os

def test_contractor_extraction():
    url = 'http://localhost:3000/api/smart-invoice'
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∫–∞–∫ –≤ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º —Å–ª—É—á–∞–µ
    test_content = '''–°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É ‚Ññ –£–¢-784 –æ—Ç 16 —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥.       
–ü–æ—Å—Ç–∞–≤—â–∏–∫: –û–û–û "–ü–†–ê–ö–¢–ò–ö", –ò–ù–ù 7804702556, –ö–ü–ü 780401001, 195197, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ –≥, –≤–Ω.—Ç–µ—Ä.–≥. –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –§–∏–Ω–ª—è–Ω–¥—Å–∫–∏–π –æ–∫—Ä—É–≥, —É–ª –ú–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è, –¥. 13, –ª–∏—Ç–µ—Ä–∞ –ê, –ø–æ–º–µ—â. 5–ù, 6–ù, 22–ù, 23–ù, 32–ù, 33–ù, 34–ù,35–ù, 36–ù, 37–ù, 38–ù, 39–ù, 40–ù, 42–ù, 43–ù,44–ù, 45–ù,–ü–û–ú–ï–©. 40–ù, —Ç–µ–ª.: (812)326-05-47

–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: –ò–ü –¢–∫–∞—á–µ–≤ –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –û–ª–µ–≥–æ–≤–∏—á, –ò–ù–ù 784802613697, –ì–æ—Ä–æ–¥ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –≤–Ω.—Ç–µ—Ä.–≥. –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –∑–∞—Å—Ç–∞–≤–∞

‚Ññ –¢–æ–≤–∞—Ä—ã (—Ä–∞–±–æ—Ç—ã, —É—Å–ª—É–≥–∏) –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¶–µ–Ω–∞ –°—Ç–∞–≤–∫–∞ –ù–î–° –°—É–º–º–∞ –ù–î–° –°—É–º–º–∞
1 –ü—Ä–æ—Ñ–∏–ª—å —Å—Ç–æ–π–∫–∏ AYPC.F50.0103 (—Ü–≤. RAL7016M) 6.8 –º 1631.61 20 1849.16 11094.95
2 –ü—Ä–æ—Ñ–∏–ª—å —Ä–∏–≥–µ–ª—è AYPC.F50.0206 (—Ü–≤. RAL7016M) 6.8 –º 1567.14 20 1776.1 10656.58
3 –ü—Ä–æ—Ñ–∏–ª—å —Ä–∞–º—ã AYPC.W72.0104. (—Ü–≤. RAL9005M) 6.5 –º 2244.46 20 2431.49 14588.96

–ò—Ç–æ–≥–æ: 36340.49
–í —Ç.—á. –ù–î–° (20%): 6056.75
–ò—Ç–æ–≥–æ —Å –ù–î–°: 36340.49
–í—Å–µ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π 3, –Ω–∞ —Å—É–º–º—É 36 340,49 —Ä—É–±.        
–¢—Ä–∏–¥—Ü–∞—Ç—å —à–µ—Å—Ç—å —Ç—ã—Å—è—á —Ç—Ä–∏—Å—Ç–∞ —Å–æ—Ä–æ–∫ —Ä—É–±–ª–µ–π 49 –∫–æ–ø–µ–µ–∫   
'''
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    temp_file = 'temp_test_contractor.txt'
    with open(temp_file, 'w', encoding='utf-8') as f:
        f.write(test_content)
    
    try:
        with open(temp_file, 'rb') as f:
            files = {'file': ('test_contractor.txt', f, 'text/plain')}
            data = {'dpi': '300'}
            
            print(f"üì§ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
            print(f"   –û–ñ–ò–î–ê–ï–ú: '–û–û–û –ü–†–ê–ö–¢–ò–ö'")
            print(f"   –ù–ï –î–û–õ–ñ–ù–û –ë–´–¢–¨: '–¢–∫–∞—á–µ–≤ –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –û–ª–µ–≥–æ–≤–∏—á'")
            print(f"üìÅ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫: {url}")
            
            response = requests.post(url, files=files, data=data)
            
            print(f"üìä –°—Ç–∞—Ç—É—Å: {response.status_code}")
            
            if response.status_code == 200:
                result = response.json()
                print("‚úÖ –£—Å–ø–µ—à–Ω–æ!")
                
                if result.get('success') and result.get('data'):
                    contractor = result['data']['contractor']
                    print(f"\nüéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:")
                    print(f"  ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: '{contractor['name']}'")
                    print(f"  ‚Ä¢ –ò–ù–ù: {contractor['inn']}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å
                    if '–ü–†–ê–ö–¢–ò–ö' in contractor['name'] or '–ø—Ä–∞–∫—Ç–∏–∫' in contractor['name'].lower():
                        print("‚úÖ –£–°–ü–ï–•: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫ '–û–û–û –ü–†–ê–ö–¢–ò–ö'!")
                    elif '–¢–∫–∞—á–µ–≤' in contractor['name']:
                        print("‚ùå –û–®–ò–ë–ö–ê: –ò–∑–≤–ª–µ—á–µ–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –≤–º–µ—Å—Ç–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞")
                    else:
                        print("‚ö†Ô∏è –ù–ï–û–ñ–ò–î–ê–ù–ù–û: –ò–∑–≤–ª–µ—á–µ–Ω–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ")
                        
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ò–ù–ù
                    if contractor['inn'] == '7804702556':
                        print("‚úÖ –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")
                    elif contractor['inn'] == '784802613697':
                        print("‚ùå –û–®–ò–ë–ö–ê: –ò–∑–≤–ª–µ—á–µ–Ω –ò–ù–ù –ø–æ–∫—É–ø–∞—Ç–µ–ª—è!")
                    else:
                        print(f"‚ö†Ô∏è –ù–ï–û–ñ–ò–î–ê–ù–ù–´–ô –ò–ù–ù: {contractor['inn']}")
                        
                else:
                    print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ")
                    print(json.dumps(result, indent=2, ensure_ascii=False))
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")
                print(response.text)
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if os.path.exists(temp_file):
            os.remove(temp_file)

if __name__ == "__main__":
    test_contractor_extraction()