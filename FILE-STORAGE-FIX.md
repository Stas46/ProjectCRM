# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å—á–µ—Ç–æ–≤

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–†–∞–Ω—å—à–µ —Å–∏—Å—Ç–µ–º–∞ **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–ª–∞ Excel —Ñ–∞–π–ª—ã** –≤ Supabase Storage.
–¢–æ–ª—å–∫–æ PDF –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—É—á–∞–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.

## ‚ú® –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
- **–î–æ**: Excel —Ñ–∞–π–ª—ã –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏—Å—å —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º "Storage –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Excel"
- **–ü–æ—Å–ª–µ**: –í—Å–µ —Ñ–∞–π–ª—ã (PDF, Excel, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Storage

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ MIME-—Ç–∏–ø—ã
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö Content-Type –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:

```typescript
PDF:   application/pdf
XLSX:  application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
XLS:   application/vnd.ms-excel
XLSM:  application/vnd.ms-excel.sheet.macroEnabled.12
JPG:   image/jpeg
PNG:   image/png
GIF:   image/gif
WebP:  image/webp
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:
- –¢–∏–ø —Ñ–∞–π–ª–∞ (Excel/PDF/Image)
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
- –ü—É–±–ª–∏—á–Ω—ã–π URL

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–§–∞–π–ª**: `src/app/api/smart-invoice/route.ts`

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Excel
```typescript
// –ë–´–õ–û:
if (!isExcel) {
  fileUrl = await uploadFileToStorage(file);
} else {
  console.log('Excel - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Storage');
}

// –°–¢–ê–õ–û:
fileUrl = await uploadFileToStorage(file); // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ç–∏–ø—ã
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –£–ª—É—á—à–µ–Ω—ã MIME-—Ç–∏–ø—ã
```typescript
// –ë–´–õ–û:
if (isExcel) {
  contentType = 'application/octet-stream'; // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø
}

// –°–¢–ê–õ–û:
if (fileExt === 'xlsx') {
  contentType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
} else if (fileExt === 'xls') {
  contentType = 'application/vnd.ms-excel';
}
// + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ xlsm, gif, webp
```

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—á–µ—Ç–æ–≤

```sql
-- –í Supabase SQL Editor
SELECT 
  id,
  invoice_number,
  file_url,
  created_at
FROM invoices
WHERE file_url IS NULL OR file_url = ''
ORDER BY created_at DESC;
```

–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Å—á–µ—Ç–∞ –±–µ–∑ `file_url` - —ç—Ç–æ –±—ã–ª–∏ Excel —Ñ–∞–π–ª—ã.

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª —Å—á–µ—Ç–æ–≤
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª (`.xlsx`, `.xls` –∏–ª–∏ `.xlsm`)
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - –í –ë–î –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω `file_url`
   - URL –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å (–æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ URL —Ñ–∞–π–ª–∞

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```
https://fpnugtlchxigwpqwiczc.supabase.co/storage/v1/object/public/invoice-files/invoices/1699876543210-abc123.xlsx
```

–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ - —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–∫–∞—á–∞—Ç—å—Å—è.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Storage

–ï—Å–ª–∏ bucket `invoice-files` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:

### –í–∞—Ä–∏–∞–Ω—Ç 1: SQL —Å–∫—Ä–∏–ø—Ç
```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª setup-storage.sql –≤ Supabase SQL Editor
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É—é
1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard)
2. Storage ‚Üí New Bucket
3. Name: `invoice-files`
4. Public: ‚úÖ –í–∫–ª—é—á–∏—Ç—å
5. Create bucket

**–ü–æ–¥—Ä–æ–±–Ω–µ–µ**: –°–º. `docs/storage-setup.md`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
ssh root@82.97.253.12 "pm2 logs crm-glazing | grep Storage"
```

–£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
```
‚úÖ –§–∞–π–ª —Å—á–µ—Ç_123.xlsx —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: https://...
üìé –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª: 1699876543210-abc123.xlsx (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
```

## üöÄ –î–µ–ø–ª–æ–π

–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ push –≤ main:
```bash
git add .
git commit -m "fix: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤ —Å—á–µ—Ç–æ–≤ (PDF, Excel, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)"
git push origin master
```

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å **–≤—Å–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤** —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- ‚úÖ PDF —Ñ–∞–π–ª—ã
- ‚úÖ Excel —Ñ–∞–π–ª—ã (.xlsx, .xls, .xlsm)
- ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (jpg, png, gif, webp)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ MIME-—Ç–∏–ø—ã
- ‚úÖ –ü—É–±–ª–∏—á–Ω—ã–µ URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
