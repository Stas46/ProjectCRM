#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
"""

import requests
import json

def test_contractor_inn_extraction():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"""
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π
    test_text = """
–°–ß–ï–¢ ‚Ññ 7 –æ—Ç 02.10.2024–≥.

–ü–æ—Å—Ç–∞–≤—â–∏–∫: –û–û–û "–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π –°—Ç–∏–°"
7720774346/470645001 –û–û–û
–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1

–ó–∞–∫–∞–∑—á–∏–∫: –ò–ù–ù 784802613697 –¢–∫–∞—á–µ–≤ –û–ª–µ–≥ –°–µ—Ä–≥–µ–µ–≤–∏—á
–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 2

–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: –û—Å—Ç–µ–∫–ª–µ–Ω–∏–µ –±–∞–ª–∫–æ–Ω–∞
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1
–¶–µ–Ω–∞: 45000.00
–°—É–º–º–∞: 45000.00
–ù–î–°: 8100.00
–ò—Ç–æ–≥–æ –∫ –¥–æ–ø–ª–∞—Ç–µ: 53100.00
    """
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞...")
    print(f"üìù –¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:")
    print(f"   - –ü–æ—Å—Ç–∞–≤—â–∏–∫: –û–û–û –ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π –°—Ç–∏–° —Å –ò–ù–ù 7720774346")
    print(f"   - –ó–∞–∫–∞–∑—á–∏–∫: –¢–∫–∞—á–µ–≤ –û–ª–µ–≥ –°–µ—Ä–≥–µ–µ–≤–∏—á —Å –ò–ù–ù 784802613697")
    print(f"   - –û–∂–∏–¥–∞–µ–º: –Ω–∞–∑–≤–∞–Ω–∏–µ='–û–û–û –ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π –°—Ç–∏–°', –ò–ù–ù='7720774346'\n")
    
    # –ò–º–∏—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ route.ts
    import re
    
    # 1. –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞)
    contractor_patterns = [
        r'–ü–æ—Å—Ç–∞–≤—â–∏–∫[:\s]*([^,\n]*?(?:–û–û–û|–ò–ü|–ê–û|–ó–ê–û|–û–ê–û|–ü–ê–û)[^,\n]*)',
        r'((?:–û–û–û|–ò–ü|–ê–û|–ó–ê–û|–û–ê–û|–ü–ê–û)[^,\n]*–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π[^,\n]*)',
    ]
    
    contractor_name = None
    for pattern in contractor_patterns:
        match = re.search(pattern, test_text, re.IGNORECASE)
        if match:
            contractor_name = match.group(1).strip()
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {contractor_name}")
            break
    
    # 2. –ü–æ–∏—Å–∫ –ò–ù–ù (–¥–æ–ª–∂–µ–Ω –∏—Å–∫–ª—é—á–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫–∞)
    buyer_inns = []
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ò–ù–ù –∏–∑ —Å–µ–∫—Ü–∏–π –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π/–∑–∞–∫–∞–∑—á–∏–∫–æ–≤
    buyer_sections = [
        r'–ó–∞–∫–∞–∑—á–∏–∫:[\s\S]*?–ò–ù–ù[\s:]*(\d{10,12})',
        r'–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:[\s\S]*?–ò–ù–ù[\s:]*(\d{10,12})'
    ]
    
    for pattern_str in buyer_sections:
        pattern = re.compile(pattern_str, re.IGNORECASE)
        for match in pattern.finditer(test_text):
            buyer_inns.append(match.group(1))
            print(f"üö´ –ù–∞–π–¥–µ–Ω –ò–ù–ù –ø–æ–∫—É–ø–∞—Ç–µ–ª—è/–∑–∞–∫–∞–∑—á–∏–∫–∞ (–∏—Å–∫–ª—é—á–∞–µ–º): {match.group(1)}")
    
    # –ò—â–µ–º –≤—Å–µ –ò–ù–ù –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π, –∫–æ—Ç–æ—Ä—ã–π –ù–ï —è–≤–ª—è–µ—Ç—Å—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º
    inn_match = None
    all_inn_matches = re.finditer(r'–ò–ù–ù[\s:]*(\d{10,12})', test_text, re.IGNORECASE)
    for match in all_inn_matches:
        if match.group(1) not in buyer_inns:
            inn_match = match.group(1)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ò–ù–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: {inn_match}")
            break
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è "–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π"
    if not inn_match and contractor_name and '–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π' in contractor_name:
        # –ü–∞—Ç—Ç–µ—Ä–Ω 1: –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º
        stis_inn_before = re.search(r'(\d{10,12})\/\d+\s+–û–û–û\s*"?–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π', test_text, re.IGNORECASE)
        if stis_inn_before:
            inn_match = stis_inn_before.group(1)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ò–ù–ù —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –ü–ï–†–ï–î '–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π': {inn_match}")
        else:
            # –ü–∞—Ç—Ç–µ—Ä–Ω 2: –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –ø–æ—Å–ª–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
            supplier_line_match = re.search(r'–ü–æ—Å—Ç–∞–≤—â–∏–∫[:\s]*[^\n]*–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π[^\n]*\n\s*(\d{10,12})', test_text, re.IGNORECASE)
            if supplier_line_match:
                inn_match = supplier_line_match.group(1)
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ò–ù–ù –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –ø–æ—Å–ª–µ '–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π': {inn_match}")
    
    # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞ –≤ —Å–µ–∫—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    if not inn_match:
        supplier_section_match = re.search(r'–ü–æ—Å—Ç–∞–≤—â–∏–∫[\s\S]*?(\d{10,12})', test_text, re.IGNORECASE)
        if supplier_section_match and supplier_section_match.group(1) not in buyer_inns:
            inn_match = supplier_section_match.group(1)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –≤ —Å–µ–∫—Ü–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: {inn_match}")
    
    print(f"\nüéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:")
    print(f"   - –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {contractor_name}")
    print(f"   - –ò–ù–ù: {inn_match}")
    
    if contractor_name == '–û–û–û "–ì—Ä—É–ø–ø–∞ –∫–æ–º–ø–∞–Ω–∏–π –°—Ç–∏–°"' and inn_match == '7720774346':
        print("‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞!")
        return True
    else:
        print("‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: –î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω–æ!")
        return False

if __name__ == "__main__":
    test_contractor_inn_extraction()